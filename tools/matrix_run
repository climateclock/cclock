#!/bin/bash

cd $(dirname "$0")
cd ..

if [ "$1" = "-q" ]; then
    quick=yes
    shift
fi

module="$1"
module=${module%.py}
target=/Volumes/CIRCUITPY
unalias -a

if [ -z "$module" ]; then
    echo "Usage: $0 [-q] <module>"
    echo
    echo "Runs a module on the attached CircuitPython device, using"
    echo "adafruit.rgbmatrix as the graphics driver.  Specify -q for"
    echo "a quick run (skip reinstalling data, libraries, and fonts)."
    exit 1
fi

if ! python3 -c "from $module import run"; then
    exit 1
fi

if [ ! -d "$target" ]; then
    echo "No drive found at $target.  Is a CircuitPython device connected?"
    exit 1
fi

if [ ! -d cache/lib ]; then
    echo "The cache/lib directory is missing.  Did you run tools/setup?"
    exit 1
fi

echo "Installing clock program..."
rm -rf $target/v999
mkdir $target/v999
cp *.py $target/v999

if [ -z "$quick" ]; then
    echo "Installing climateclock.json..."
    curl https://api.climateclock.world/v1/clock -o cache/climateclock.json
    mkdir -p $target/cache
    cp cache/climateclock.json $target/cache

    echo "Installing fonts..."
    cp *.pcf $target

    mkdir -p $target/lib
    for lib in bitmap_font datetime display_text ds3231 esp32spi matrixportal register requests; do
        echo "Installing $lib..."
        rm -rf $target/lib/adafruit_$lib*
        cp -r cache/lib/adafruit_$lib* $target/lib/
    done
fi

echo "Installing startup logic..."
cp boot.py code.py gpio.py $target

cat <<EOF >$target/v999/main.py
import matrix_frame
frame = matrix_frame.new_display_frame(192, 32, 16)

import board, gpio
up = gpio.Button(board.BUTTON_UP)
down = gpio.Button(board.BUTTON_DOWN)

from $module import run
run(frame, {'NEXT': up, 'ENTER': down})
EOF

touch $target/v999/@VALID
touch $target/v999/@ENABLED
echo "All done!"
