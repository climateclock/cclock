#!/bin/bash

cd $(dirname "$0")
cd ..

if ! [ -d env ]; then
    python3 -m venv env
fi
pip3 install -U -r requirements.txt

if ! [ -x env/bin/mpy-cross ]; then
    # mpy-cross binaries for many architectures are available at
    # https://adafruit-circuit-python.s3.amazonaws.com/index.html?prefix=bin/mpy-cross/
    if [ $(uname) = Linux ]; then
        curl -o env/bin/mpy-cross https://adafruit-circuit-python.s3.amazonaws.com/bin/mpy-cross/mpy-cross.static-amd64-linux-8.0.0-beta.0-22-g3ba385ff5
        chmod 755 env/bin/mpy-cross
    elif [ $(uname) = Darwin ]; then
        curl -o env/bin/mpy-cross https://adafruit-circuit-python.s3.amazonaws.com/bin/mpy-cross/mpy-cross-macos-11-8.0.0-beta.0-22-g3ba385ff5-universal
        chmod 755 env/bin/mpy-cross
    else
        echo "Please find and install 'mpy-cross' for your platform."
        echo "Be sure to get a version compatible with CircuitPython 8.0.0."
        echo
        echo "https://adafruit-circuit-python.s3.amazonaws.com/index.html?prefix=bin/mpy-cross/"
        exit 1
    fi
fi

if ! [ -d cache ]; then
    mkdir cache
fi

# Clone the source code of some of the Python libraries,
# at the exact versions used in the current firmware.uf2 file.

if ! [ -d Adafruit_CircuitPython_ESP32SPI ]; then
    git clone https://github.com/adafruit/Adafruit_CircuitPython_ESP32SPI
fi
cd Adafruit_CircuitPython_ESP32SPI
git checkout 5.0.1
cd ..

if ! [ -d Adafruit_CircuitPython_Hashlib ]; then
    git clone https://github.com/adafruit/Adafruit_CircuitPython_Hashlib
fi
cd Adafruit_CircuitPython_Hashlib
git checkout 1.4.9
cd ..

if ! [ -d Adafruit_CircuitPython_MatrixPortal ]; then
    git clone https://github.com/adafruit/Adafruit_CircuitPython_MatrixPortal
fi
cd Adafruit_CircuitPython_MatrixPortal
git checkout 3.0.10
cd ..

